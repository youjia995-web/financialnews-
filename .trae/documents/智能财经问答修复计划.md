# 智能财经问答修复计划

用户反馈“智能财经问答”功能在提问“a 股内关于 cpu 的股票推荐哪些可以明天入手”时没有输出结果。这可能是由于后端超时、模型调用失败或前端渲染问题导致的。

## 1. 问题排查与分析

1.  **超时风险**：DeepSeek 接口响应较慢，或者 Tavily 搜索 + 数据库查询耗时过长，导致 Vercel/Next.js 的 Serverless Function 默认超时（通常 10s 或 60s）。
2.  **错误处理缺失**：如果 `deepseek.chat` 抛出错误，`analyzeQuery` 没有 `try-catch` 包裹，导致接口直接 500 崩溃，前端没有收到 JSON 响应。
3.  **Prompt 长度问题**：如果搜索结果过多，Prompt 可能超长。

## 2. 修复方案

### 2.1 增强错误处理 (`src/ai/analyst.js`)
*   为 `analyzeQuery` 函数添加 `try-catch` 块。
*   在 `catch` 中打印详细错误日志，并返回友好的错误信息给前端。

### 2.2 优化响应逻辑
*   如果 DeepSeek 调用失败，尝试降级（例如仅返回搜索结果摘要，或提示用户稍后重试）。
*   检查 `deepseek.js` 的实现，确保有超时重试机制（可选）。

### 2.3 前端反馈优化 (`app/analyst/page.js`)
*   目前前端已经有 `setError`，但如果后端直接崩溃（非 JSON 响应），`res.json()` 会报错。需要加 `try-catch` 解析 JSON。

## 3. 执行步骤

1.  **修改 `src/ai/analyst.js`**：
    *   为 `analyzeQuery` 添加 `try-catch`。
    *   增加日志输出 `console.log('DeepSeek input:', ...)` 以便调试。
2.  **修改 `app/analyst/page.js`**：
    *   优化 `handleSubmit` 中的 JSON 解析逻辑，防止非 JSON 响应（如 504 Gateway Timeout HTML）导致前端白屏或无反应。
3.  **测试**：模拟用户提问，观察控制台日志。

## 4. 补充优化 (Prompt)
*   用户问的是“推荐股票”，涉及投资建议。建议在 Prompt 中加入免责声明引导，让 AI 输出“仅供参考，不构成投资建议”。

## 5. 代码变更预览

```javascript
// src/ai/analyst.js
async function analyzeQuery(query) {
  try {
    // ... search logic ...
    const result = await deepseek.chat(...)
    return result
  } catch (e) {
    console.error('Analyze Query Failed:', e)
    throw new Error('AI 思考超时或服务繁忙，请稍后重试')
  }
}
```
