# 个股深度诊断逻辑重构计划

本计划旨在通过引入“三引擎驱动”架构（数据引擎 + 信息引擎 + 决策引擎），重构现有的个股深度诊断功能。通过 Python 进行数据清洗与特征工程，利用 Tavily 进行历史归因分析，最终由 Qwen-Max 进行综合分析与策略生成。

## 1. 核心架构设计

*   **数据引擎**: 负责从数据库提取历史数据，并使用 Python (`pandas`, `talib`) 计算技术指标（MA, MACD, RSI, KDJ, Bollinger Bands, ATR, Volatility）。同时负责筛选“关键事件日”（大涨大跌或巨量）。
*   **信息引擎**: 针对筛选出的“关键事件日”，利用 Tavily API 搜索当时的新闻，构建“日期-事件”映射。
*   **决策引擎**: 将技术指标摘要、关键事件及其新闻归因喂给 Qwen-Max，让 AI 分析“股性”并生成具体的交易策略（困境反转或趋势跟随）。

## 2. 实施步骤

### 2.1 环境准备
*   在 `package.json` 中添加 `python-shell` 依赖，以便在 Node.js 中调用 Python 脚本。
*   创建 `py/` 目录存放 Python 脚本。
*   **注意**: 用户环境需要预装 Python 3 以及 `pandas`, `talib-binary` (或 `ta-lib`), `numpy` 库。我将编写脚本检查并尝试安装这些依赖（如果可能），或者生成 `requirements.txt` 并提示用户安装。

### 2.2 第一步：数据清洗与特征工程 (Python)
*   **任务**: 编写 `py/indicators.py`。
*   **输入**: 从 Node.js 通过 stdin 传入的 JSON 格式 OHLCV 数据（从 Postgres 查询得到）。
*   **处理**:
    *   使用 `pandas` 创建 DataFrame。
    *   使用 `talib` 计算:
        *   MA5, MA20, MA60
        *   MACD (12, 26, 9)
        *   RSI (14)
        *   KDJ (9, 3, 3)
        *   BBANDS (20, 2)
        *   ATR (14)
        *   HistVolatility (20日历史波动率)
    *   **关键事件筛选**:
        *   涨跌幅 > ±5%
        *   成交量 > 5日均量 * 3
    *   **输出**: 返回包含最新指标状态的 JSON 对象，以及筛选出的“关键异常日期列表”。

### 2.3 第二步：历史归因 (Node.js + Tavily)
*   **任务**: 更新 `src/ai/analyst.js` 中的 `analyzeStock` 逻辑。
*   **逻辑**:
    1.  调用 `prisma.stockDaily` 获取该股票的全量（或近10年）历史数据。
    2.  调用 `py/indicators.py` 计算指标并获取“异常日期列表”（限制数量，例如最近的 5-10 个关键日，避免 Token 爆炸）。
    3.  **并发**调用 `tavily.search`，针对每个异常日期搜索：“{股票代码} {日期} 大跌原因”或“{股票代码} {日期} 利好”。
    4.  同时搜索“今日”的实时新闻。
    5.  汇总生成“事件数据库”文本。

### 2.4 第三步：AI 综合分析 (Qwen-Max)
*   **任务**: 更新 `src/ai/analyst.js` 中的 Prompt 构建逻辑。
*   **Prompt 结构优化**:
    *   **角色**: 资深量化交易员与基本面分析师。
    *   **输入数据**:
        *   **最新技术面**: 当前价格、MA排列、RSI/MACD状态、波动率。
        *   **历史股性分析**: 提供过去几次大跌/大涨日期的技术形态 + 当时的新闻原因。让 AI 总结规律（如：对什么消息敏感？反弹周期？）。
        *   **今日情报**: 今日实时新闻。
    *   **输出要求**:
        *   **股性画像**: 波动率特征、消息敏感度。
        *   **量化策略匹配**: 推荐“困境反转”还是“趋势跟随”？
        *   **实盘建议**: 结合今日数据与新闻给出明确操作指令。

## 3. 具体修改文件
1.  **新增**: `py/requirements.txt` (Python 依赖)。
2.  **新增**: `py/indicators.py` (特征工程脚本)。
3.  **修改**: `package.json` (添加 `python-shell`)。
4.  **修改**: `src/ai/analyst.js` (重写 `analyzeStock` 函数，集成 Python 调用与 Tavily 历史搜索)。

## 4. 验证计划
1.  确保本地 Python 环境可用（用户需配合安装依赖）。
2.  运行个股诊断，检查 Python 脚本是否正确输出指标。
3.  检查 Tavily 是否正确搜索到了历史日期的相关新闻。
4.  检查 Qwen-Max 输出的报告是否包含“股性分析”和基于历史规律的策略建议。
