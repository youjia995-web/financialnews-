# 重构 AI 分析报告的“交易策略建议”部分

## 1. 目标
根据用户反馈，将“交易策略建议”部分从简单的 A/B 模板重构为基于数学家和股票交易专家视角的深度分析。重点引入统计学语言（标准差、均值回归、胜率预估）和实战逻辑（仓位管理、盘口博弈）。

## 2. Prompt 设计变更
将 `src/ai/analyst.js` 中 `prompt` 变量的“交易策略建议”及后续部分替换为以下结构：

### 新的策略模块结构
*   **策略分类**：
    *   **左侧交易（逆势/均值回归）**：适用于震荡市或超跌/超买。
    *   **右侧交易（顺势/动量）**：适用于趋势市。
*   **内容增强**：
    *   **入场计划**：基于 ATR 和均线的具体价格区间。
    *   **风控系统**：明确的止损位（基于 ATR）和动态止盈逻辑。
    *   **资金管理**：基于波动率的仓位建议（Kelly 公式视角）。
    *   **盘口博弈**：基于 VWAP 的日内强弱判断。

### 具体 Prompt 模板
```markdown
### ♟️ 交易策略建议 (数学与实战融合)
请基于上述量化指标，构建两套互斥或互补的策略方案：

#### 方案一：[策略名称，如：均值回归/趋势跟随] (置信度: 高/中/低)
*   **数学逻辑**：[解释为什么选此策略，例如：当前股价偏离 MA20 超过 2个标准差，存在回归需求；或 ADX 显示趋势强度 > 25，适合动量策略]
*   **入场计划**：
    *   **触发条件**：[具体价格行为，如：回踩 MA20 不破且出现缩量阳线]
    *   **建议价格**：[基于 ATR 计算的区间，如：${fmt(latest.close - (latest.signals?.atr || 0) * 0.5)} ~ ${fmt(latest.close)}]
*   **风控系统**：
    *   **止损位**：${fmt(stopLoss)} (基于 2xATR 动态止损)
    *   **目标位**：[基于风险收益比 1:2 设定，即 Entry + 2 * (Entry - StopLoss)]
    *   **仓位建议**：[根据波动率 ${latest.volatility ? fmt(latest.volatility * 100) : '-'}% 建议，高波动低仓位]

#### 方案二：[备选策略，如：网格交易/突破追涨]
*   **适用场景**：[如：若方案一失效，或市场进入横盘震荡]
*   **操作逻辑**：...

#### 💡 资金管理与执行指令
*   **凯利公式视角**：[基于当前技术面胜率预估，建议单笔投入比例（保守/激进）]
*   **盘口博弈**：[关注 VWAP ${fmt(vwap)} 的得失，若盘中跌破...]
```

## 3. 实施步骤
1.  修改 `src/ai/analyst.js`，更新 `prompt` 模板字符串。
2.  确保模板中引用的变量（如 `latest.volatility`, `vwap`, `stopLoss` 等）均已在作用域内定义且可用。
3.  验证生成的新报告格式是否符合预期。